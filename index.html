<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>MTRK Web</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    </head>
    <body>

        <div class ="container">
            <div id="chart1"></div>
        </div>

        

        <script type="module">

            import data from "./miniflash.json" assert { type: 'json' };
            
            const rf_pulse_data = data["arrays"]["rfpulse"]["data"]
            const rf_odd_data = []
            const rf_even_data = []
            for (let i=0; i < 128; i++) {
                rf_even_data.push(rf_pulse_data[2*i]);
                rf_odd_data.push(rf_pulse_data[2*i+1])
            }

            const rf_data = Array(2000).fill(0);
            const slice_data = Array(2000).fill(0);
            const phase_data = Array(2000).fill(0);
            const readout_data = Array(2000).fill(0);
            const adc_data = Array(2000).fill(0);

            // Filling rf data
            let t = 10;
            for (let i=0; i<rf_even_data.length; i++) {
                rf_data[t] = rf_even_data[i];
                t++;
            }

            // Storing the steps
            const steps = data["instructions"]["block_TR"]["steps"];

            // Executing each step and filling axis arrays.
            steps.forEach(function (item, index) {
                if(item["axis"] == "slice" || item["axis"] == "phase" || item["axis"] == "read") {
                    let start = item["time"]/10;
                    let object = item["object"];
                    let amplitude = parseInt(data["objects"][object]["amplitude"]);

                    // Updating the amplitude if available in the step.
                    if ("amplitude" in item) {
                        if (item["amplitude"] === "flip") {
                            amplitude = amplitude * -1;
                        }
                        else if ("equation" in item["amplitude"]) {
                            amplitude = 0.3378125*(1-64.5);
                            data["objects"][object]["amplitude"] = amplitude;
                        }
                    }

                    let array_name = data["objects"][object]["array"];
                    let array_data = data["arrays"][array_name]["data"].map(function(x) { return x * -amplitude});

                    for (let i=0; i<array_data.length; i++) {
                        if (item["axis"] == "slice") { 
                            slice_data[start] = array_data[i]; 
                        } else if (item["axis"] == "phase") { 
                            phase_data[start] = array_data[i]; 
                        } else if (item["axis"] == "read") { 
                            readout_data[start] = array_data[i];
                        }
                        start++;
                    }
                } else if (item["action"] == "adc") {
                    let start = item["time"]/10;
                    let object = item["object"];
                    let duration = data["objects"][object]["duration"]/10;
                    
                    for (let i=0; i<duration; i++) {
                        adc_data[start] = 1;
                        start += 1
                    }
                }
            });
            

            // Taking standard x-axis for all the plots.
            const x_standard = []
            for (let i=0; i<20000; i+=10) {
                x_standard.push(i);
            }

            const plot_rf_data = {
            x: x_standard,
            y: rf_data,
            xaxis: 'x1',
            yaxis: 'y1',
            type: 'scatter',
            mode: 'lines+markers',
            marker: { size: 5 },
            name: 'rf pulse'
            // line: { color: 'steelblue' }
            };

            const plot_slice_data = {
            x: x_standard,
            y: slice_data,
            xaxis: 'x2',
            yaxis: 'y2',
            type: 'scatter',
            mode: 'lines+markers',
            name: 'slice',
            marker: { size: 5 },
            // line: { color: 'steelblue' }
            };

            const plot_phase_data = {
            x: x_standard,
            y: phase_data,
            xaxis: 'x3',
            yaxis: 'y3',
            type: 'scatter',
            mode: 'lines+markers',
            name: 'phase',
            marker: { size: 5 },
            // line: { color: 'steelblue' }
            };

            const plot_readout_data = {
            x: x_standard,
            y: readout_data,
            xaxis: 'x4',
            yaxis: 'y4',
            type: 'scatter',
            mode: 'lines+markers',
            name: 'readout',
            marker: { size: 5 },
            // line: { color: 'steelblue' }
            };

            const plot_adc_data = {
            x: x_standard,
            y: adc_data,
            xaxis: 'x5',
            yaxis: 'y5',
            type: 'scatter',
            mode: 'lines+markers',
            name: 'adc',
            marker: { size: 5 },
            // line: { color: 'steelblue' }
            };

            var stacked_plots = [plot_rf_data, plot_slice_data, plot_phase_data, plot_readout_data, plot_adc_data];

            var layout = {
            grid: {
                rows: 5,
                columns: 1,
                pattern: 'independent'},
            height: 1200,
            xaxis1: {
                tickformat: "digits"
            },
            xaxis2: {
                tickformat: "digits"
            },
            xaxis3: {
                tickformat: "digits"
            },
            xaxis4: {
                tickformat: "digits"
            },
            xaxis5: {
                title: "time (Âµs)",
                titlefont: {
                    family: 'Arial, sans-serif',
                    size: 18,
                    color: 'gray'
                },
                tickformat: "digits"
            },
            yaxis1: {
                title: "V",
                titlefont: {
                    family: 'Arial, sans-serif',
                    size: 16,
                    color: 'gray'
                }
            },
            yaxis2: {
                title: "mT/m",
                titlefont: {
                    family: 'Arial, sans-serif',
                    size: 16,
                    color: 'gray'
                }
            },
            yaxis3: {
                title: "mT/m",
                titlefont: {
                    family: 'Arial, sans-serif',
                    size: 16,
                    color: 'gray'
                }
            },
            yaxis4: {
                title: "mT/m",
                titlefont: {
                    family: 'Arial, sans-serif',
                    size: 16,
                    color: 'gray'
                }
            },
            yaxis5: {
                title: "mT/m",
                titlefont: {
                    family: 'Arial, sans-serif',
                    size: 16,
                    color: 'gray'
                }
            },
            };

            Plotly.newPlot('chart1', stacked_plots, layout, {scrollZoom: true});

        </script>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    </body>
</html>
